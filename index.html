
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SRS-2 — Autorrelato</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:980px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}

  .q{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:12px}
  .q h3{margin:0 0 10px;font-size:1.02rem}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  .opt{
    display:flex;align-items:center;gap:10px;
    padding:12px 14px;border:1px solid var(--line);border-radius:12px;
    background:var(--chip); cursor:pointer; min-width:220px;
    transition:transform .05s ease, border-color .15s ease;
  }
  .opt:hover{border-color:#4466aa; transform:translateY(-1px)}
  .opt input[type="radio"]{transform:scale(1.15)}
  @media (max-width:520px){ .opt{min-width:unset; flex:1 1 100%} }

  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>SRS-2 — Questionário (Autorrelato)</h1>
    <p class="muted">
      Responda a todas as afirmações abaixo. As opções são:
      <em>Não é verdade (1)</em>, <em>Algumas vezes é verdade (2)</em>,
      <em>Muitas vezes é verdade (3)</em>, <em>Quase sempre é verdade (4)</em>.
    </p>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>
      <div style="margin-top:14px">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_SRS2_AUTORRELATO" };
const CODE = "SRS2_AUTORRELATO";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";

/* Liberação (colunas possíveis em Patients) */
const RELEASE_KEYS = [
  "SRS2_AUTORRELATO",
 ];

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){
  const el = $(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-"); if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text()); return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, {
    method:"PATCH", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data })
  });
  if(!r.ok) throw new Error(await r.text()); return r.json();
}
function goPortalWithToken(){
  const TOKEN = qs("token");
  try{
    const u = new URL(PORTAL_URL, location.href);
    u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + sep + "token=" + encodeURIComponent(TOKEN);
  }
}

/* ===== ITENS / OPÇÕES ===== */
const ITEMS = [
"Eu fico muito mais desconfortável em situações sociais do que quando estou sozinho.",
"Minhas expressões faciais passam uma mensagem errada aos outros sobre como eu realmente me sinto.",
"Eu me sinto confiante (ou seguro) quando estou interagindo com os outros.",
"Quando estou sob estresse, tenho um comportamento rígido e inflexível que parece estranho para os outros.",
"Eu não reconheço quando os outros estão tentando tirar vantagem sobre mim.",
"Eu preferia estar sozinho do que com os outros.",
"Normalmente eu consigo perceber como os outros estão se sentindo.",
"Eu me comporto de maneiras que parecem estranhas ou esquisitas aos outros.",
"Eu sou excessivamente dependente dos outros para me ajudar a entender as minhas necessidades diárias.",
"Eu levo as coisas muito ao pé da letra, e por causa disso, eu interpreto mal o significado pretendido de partes de uma conversa.",
"Eu sou autoconfiante.",
"Eu sou capaz de comunicar meus sentimentos aos outros.",
"Eu fico estranho nas interações com os colegas (por exemplo, eu levo um tempo acompanhando o vai e vem da conversa).",
"Eu não sou bem coordenado.",
"Quando as pessoas mudam seu tom ou expressão facial, eu normalmente entendo o que isso significa.",
"Eu evito contato visual ou me dizem que eu tenho contato visual diferente.",
"Eu reconheço quando algo é injusto.",
"Eu tenho dificuldade em fazer amigos, mesmo quando eu tento dar o melhor de mim.",
"Eu fico frustrado tentando expressar minhas ideias em uma conversa.",
"Eu tenho interesses sensoriais que os outros acham diferentes (por exemplo, cheirar ou olhar para as coisas de um jeito especial).",
"Eu sou capaz de imitar a ação e expressões dos outros quando isso é socialmente apropriado.",
"Eu interajo apropriadamente com os outros adultos.",
"Eu não participo de atividades em grupo ou eventos sociais a menos que seja obrigado a fazê-lo.",
"Eu tenho mais dificuldade que os outros com mudanças na minha rotina.",
"Eu não me importo de não estar na mesma onda ou fora de sintonia com os outros.",
"Eu ofereço conforto aos outros quando eles estão tristes.",
"Eu evito iniciar interações sociais com outros adultos.",
"Eu penso ou falo sobre a mesma coisa repetidamente.",
"Eu sou considerado pelos outros como estranho ou esquisito.",
"Eu fico perturbado em situações com muitas coisas acontecendo.",
"Eu não consigo tirar algo da minha mente uma vez que começo pensar sobre aquilo.",
"Eu tenho boa higiene pessoal.",
"Meu comportamento é socialmente desajeitado, mesmo quando eu estou tentando ser educado.",
"Eu evito pessoas que querem ser emocionalmente próximas a mim.",
"Eu tenho dificuldade em acompanhar o fluxo de uma conversa normal.",
"Eu tenho dificuldade em me relacionar com os membros da minha família.",
"Eu tenho dificuldade em me relacionar com pessoas que não são da minha família.",
"Eu respondo adequadamente às mudanças de humor das outras pessoas (por exemplo, quando o humor de um amigo muda de feliz para triste).",
"As pessoas me acham muito interessado em poucos assuntos, ou que eu me 'deixo levar' por esses assuntos.",
"Eu sou imaginativo.",
"Eu às vezes mudo de uma atividade para outra sem nenhuma razão.",
"Eu sou excessivamente sensível a certos sons, texturas ou cheiros.",
"Eu gosto de conversas (conversas casuais com os outros).",
"Eu tenho mais problema do que a maioria das pessoas com o entendimento da causalidade (em outras palavras, como os eventos estão relacionados uns com os outros).",
"Quando os outros ao redor de mim estão prestando atenção em algo, eu fico interessado no que eles estão atentos.",
"Os outros sentem que eu tenho expressões faciais excessivamente sérias.",
"Eu dou risadas em momentos inapropriados.",
"Eu tenho um bom senso de humor e consigo entender piadas.",
"Eu sou geralmente bom em certos tipos de tarefas intelectuais, mas não sou tão bom na maioria das outras tarefas.",
"Eu tenho comportamentos repetitivos que as outras pessoas consideram estranhos.",
"Eu tenho dificuldade de responder perguntas diretamente e acabo discursando sobre o assunto.",
"Eu falo muito alto sem perceber.",
"Eu tenho tendência a falar com uma voz monótona (em outras palavras, menor inflexão da voz que a maioria das pessoas demonstra).",
"Eu tenho uma tendência a pensar sobre as pessoas do mesmo jeito que eu faço com os objetos.",
"Eu fico muito perto dos outros ou invado o espaço pessoal deles sem perceber.",
"Às vezes eu cometo o erro de andar entre duas pessoas que estão tentando conversar uma com a outra.",
"Eu tenho uma tendência a me isolar.",
"Eu me concentro demais nas partes das coisas ao invés de ver a figura como um todo.",
"Eu sou mais desconfiado que a maioria das pessoas.",
"As outras pessoas me acham emocionalmente distante e que não demonstro meus sentimentos.",
"Eu tenho uma tendência a ser inflexível.",
"Quando eu conto a alguém a minha razão para fazer alguma coisa, a pessoa acha que é incomum, sem lógica.",
"Meu jeito de cumprimentar uma outra pessoa é incomum.",
"Eu sou muito mais tenso em situações sociais do que quando eu estou sozinho.",
"Eu me pego olhando fixo para o espaço."
];
const CHOICES = [
  {label:"Não é verdade", value:0},
  {label:"Algumas vezes é verdade", value:1},
  {label:"Muitas vezes é verdade", value:2},
  {label:"Quase sempre é verdade", value:3},
];
function renderQuestions(){
  const host = $("#qs"); host.innerHTML="";
  ITEMS.forEach((text, idx)=>{
    const qn = String(idx+1).padStart(2,"0");
    const wrap = document.createElement("div");
    wrap.className="q";
    wrap.innerHTML = `<h3>${idx+1}. ${text}</h3>`;
    const opts = document.createElement("div"); opts.className="opts";
    CHOICES.forEach(c=>{
      const id=`q${qn}_${c.value}`;
      const lab=document.createElement("label"); lab.className="opt";
      lab.innerHTML = `<input type="radio" name="q${qn}" id="${id}" value="${c.value}" required><span>${c.label}</span>`;
      opts.appendChild(lab);
    });
    wrap.appendChild(opts); host.appendChild(wrap);
  });
}

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";

/* ===== BOOT ===== */
(async function boot(){
  try{
    const TOKEN = qs("token");
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){ setBox("#alert","Este formulário não está liberado para você.","err"); return; }

    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1200);
      return;
    }

    renderPatientInfo();
    renderQuestions();
    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    hideBox("#alert");

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email || "-"],
    ["WhatsApp", patient.whatsapp || "-"]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== SUBESCALAS & CÁLCULOS ===== */
const SUBS = {
  percepcao_social: [2,7,25,32,45,52,54,56],
  cognicao_social: [5,10,15,17,30,40,42,44,48,58,59,62],
  comunicacao_social_subescala: [12,13,16,18,19,21,22,26,33,35,36,37,38,41,46,47,51,53,55,57,60,61],
  motivacao_social: [1,3,6,9,11,23,27,34,43,64,65],
  rrb: [4,8,14,20,24,28,29,31,39,49,50,63] // padrões restritivos e repetitivos
};
/* Itens com pontuação invertida (0↔3, 1↔2) */
const REVERSE_ITEMS = new Set([3,7,11,12,15,17,21,22,26,32,38,40,43,45,48,52,55]);

function scoreValue(qIndex, rawValue){
  // rawValue é 0..3; inversão: 0->3,1->2,2->1,3->0
  return REVERSE_ITEMS.has(qIndex) ? (3 - rawValue) : rawValue;
}
function sumBy(arr, answers){ return arr.reduce((s,i)=> s + (answers[i] ?? 0), 0); }

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true; btn.textContent = "Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // respostas 1..65 (aplicando inversão quando necessário)
    const ans = {};
    for(let i=1;i<=65;i++){
      const qn = String(i).padStart(2,"0");
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){ throw new Error(`Responda a questão ${i}.`); }
      const raw = Number(sel.value);
      ans[i] = scoreValue(i, raw);
    }

    // totais
    const total_1a65 = Array.from({length:65},(_,k)=>k+1).reduce((s,i)=> s + ans[i], 0);
    const rrb = sumBy(SUBS.rrb, ans);
    const comunicacao_interacao = total_1a65 - rrb; // 1..65 menos RRB

    const resultado = {
      percepcao_social:   sumBy(SUBS.percepcao_social, ans),
      cognicao_social:    sumBy(SUBS.cognicao_social, ans),
      comunicacao_social_subescala: sumBy(SUBS.comunicacao_social_subescala, ans),
      motivacao_social:   sumBy(SUBS.motivacao_social, ans),
      padroes_restritivos_repetitivos: rrb,
      comunicacao_interacao,
      total: total_1a65
    };

    const categoria_csv = Object.entries(resultado).map(([k,v])=>`${k}=${v}`).join(",");

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: qs("token"),
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: resultado.total,
      categoria: categoria_csv
    });

    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{ if(k in patient) doneUpdates[k] = "sim"; });
    if(Object.keys(doneUpdates).length===0) doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    setBox("#msg","Formulário enviado!!!");
    

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false;
    btn.disabled = false; btn.textContent = originalText;
  }
});
</script>
</body>
</html>
